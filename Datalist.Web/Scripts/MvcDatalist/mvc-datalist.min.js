/*!
 * Datalist 5.0.4
 * https://github.com/NonFactors/MVC5.Datalist
 *
 * Copyright Â© NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
var MvcDatalistFilter=function(){function n(n){this.page=n.attr("data-page");this.rows=n.attr("data-rows");this.sort=n.attr("data-sort");this.order=n.attr("data-order");this.search=n.attr("data-search");this.additionalFilters=n.attr("data-filters").split(",").filter(Boolean)}return n.prototype={getQuery:function(n){for(var u,r,t=$.extend({},this,n),f="?search="+encodeURIComponent(t.search)+"&sort="+encodeURIComponent(t.sort)+"&order="+encodeURIComponent(t.order)+"&rows="+encodeURIComponent(t.rows)+"&page="+encodeURIComponent(t.page)+(t.checkIds?t.checkIds:"")+(t.ids?t.ids:""),i=0;i<this.additionalFilters.length;i++)for(u=$('[name="'+this.additionalFilters[i]+'"]'),r=0;r<u.length;r++)f+="&"+encodeURIComponent(this.additionalFilters[i])+"="+encodeURIComponent(u[r].value);return f}},n}(),MvcDatalistDialog=function(){function n(n){this.datalist=n;this.filter=n.filter;this.title=n.group.attr("data-title");this.instance=$("#"+n.group.attr("data-dialog"));this.pager=this.instance.find("ul");this.table=this.instance.find("table");this.tableHead=this.instance.find("thead");this.tableBody=this.instance.find("tbody");this.error=this.instance.find(".datalist-error");this.search=this.instance.find(".datalist-search");this.rows=this.instance.find(".datalist-rows input");this.loader=this.instance.find(".datalist-dialog-loader");this.selector=this.instance.find(".datalist-selector button");this.initOptions()}return n.prototype={set:function(n){n=n||{};$.extend(this.options.dialog,n.dialog);$.extend(this.options.spinner,n.spinner);$.extend(this.options.resizable,n.resizable)},initOptions:function(){var n=this;this.options={dialog:{classes:{"ui-dialog":"datalist-widget"},dialogClass:"datalist-widget",title:n.title,autoOpen:!1,minWidth:455,width:"auto",modal:!0},spinner:{min:1,max:99,change:function(){this.value=n.limitRows(this.value);n.filter.rows=this.value;n.filter.page=0;n.refresh()}},resizable:{handles:"w,e",stop:function(){$(this).css("height","auto")}}}},open:function(){this.loader.hide();this.search.val(this.filter.search);this.error.hide().html(this.lang("Error"));this.selected=this.datalist.selected.slice();this.rows.val(this.limitRows(this.filter.rows));this.search.attr("placeholder",this.lang("Search"));this.selector.parent().css("display",this.datalist.multi?"":"none");this.selector.text(this.lang("Select").replace("{0}",this.datalist.selected.length));this.bind();this.refresh();setTimeout(function(n){var t=n.dialog("open").parent(),r=$(document).scrollLeft(),i=$(document).scrollTop();parseInt(t.css("left"))<r&&t.css("left",r);parseInt(t.css("top"))>i+100?t.css("top",i+100):parseInt(t.css("top"))<i&&t.css("top",i)},100,this.instance)},close:function(){this.instance.dialog("close")},refresh:function(){var n=this,t;n.error.fadeOut(300);t=setTimeout(function(){n.loader.fadeIn(300)},300);$.ajax({cache:!1,url:n.datalist.url+n.filter.getQuery()+n.selected.map(function(n){return"&selected="+n.DatalistIdKey}).join(""),success:function(i){clearTimeout(t);n.render(i)},error:function(){clearTimeout(t);n.render()}})},render:function(n){this.loader.fadeOut(300);this.tableHead.empty();this.tableBody.empty();this.pager.empty();n?(this.renderHeader(n.Columns),this.renderBody(n.Columns,n.Rows),this.renderFooter(n.FilteredRows)):this.error.fadeIn(300)},renderHeader:function(n){for(var i=document.createElement("tr"),r=document.createElement("th"),t=0;t<n.length;t++)n[t].Hidden||i.appendChild(this.createHeaderColumn(n[t]));i.appendChild(r);this.tableHead.append(i)},renderBody:function(n,t){var u,i,f,s,r,e,o;for(t.length==0&&(u=this.createEmptyRow(n),u.children[0].innerHTML=this.lang("NoData"),u.className="datalist-empty",this.tableBody.append(u)),i=0;i<t.length;i++){for(f=this.createDataRow(t[i]),s=document.createElement("td"),r=0;r<n.length;r++)n[r].Hidden||(e=document.createElement("td"),e.className=n[r].CssClass||"",e.innerText=t[i][n[r].Key],f.appendChild(e));f.appendChild(s);this.tableBody.append(f);i==this.selected.length-1&&(o=this.createEmptyRow(n),o.className="datalist-split",this.tableBody.append(o))}},renderFooter:function(n){var t,r,i;if(this.totalRows=n+this.selected.length,t=Math.ceil(n/this.filter.rows),t>0){for(r=Math.floor(this.filter.page/5)*5,t>5&&this.filter.page>0&&(this.renderPage("&laquo",0),this.renderPage("&lsaquo;",this.filter.page-1)),i=r;i<t&&i<r+5;i++)this.renderPage(i+1,i);t>5&&this.filter.page<t-1&&(this.renderPage("&rsaquo;",this.filter.page+1),this.renderPage("&raquo;",t-1))}else this.renderPage(1,0)},createDataRow:function(n){var t=this,i=this.datalist,r=document.createElement("tr");i.indexOf(t.selected,n.DatalistIdKey)>=0&&(r.className="selected");$(r).on("click.datalist",function(){var r=i.indexOf(t.selected,n.DatalistIdKey);r>=0?(t.selected.splice(r,1),$(this).removeClass("selected")):(i.multi?t.selected.push(n):t.selected=[n],$(this).addClass("selected"));i.multi?t.selector.text(t.lang("Select").replace("{0}",t.selected.length)):(i.select(t.selected,!0),t.close(),i.search.focus())});return r},createEmptyRow:function(n){var t=document.createElement("tr"),i=document.createElement("td");return t.appendChild(i),i.setAttribute("colspan",n.length+1),t},createHeaderColumn:function(n){var i=document.createElement("th"),t,r;i.innerText=n.Header;t=this.filter;r=this;n.CssClass&&(i.className=n.CssClass);t.sort==n.Key&&(i.className+=" datalist-"+t.order.toLowerCase());$(i).on("click.datalist",function(){t.order=t.sort==n.Key?t.order=="Asc"?"Desc":"Asc":"Asc";t.sort=n.Key;r.refresh()});return i},renderPage:function(n,t){var r=document.createElement("span"),u=document.createElement("li"),i;if(u.appendChild(r),r.innerHTML=n,i=this,i.filter.page==t)u.className="active";else $(r).on("click.datalist",function(){var n=Math.ceil((i.totalRows-i.selected.length)/i.filter.rows);i.filter.page=t<n?t:n-1;i.refresh()});i.pager.append(u)},limitRows:function(n){var t=this.options.spinner;return Math.min(Math.max(parseInt(n),t.min),t.max)||this.filter.rows},lang:function(n){return $.fn.datalist.lang[n]},bind:function(){var t,n=this;n.instance.dialog().dialog("destroy");n.instance.dialog(n.options.dialog);n.instance.dialog("option","close",function(){n.datalist.multi&&(n.datalist.select(n.selected,!0),n.datalist.search.focus())});n.instance.parent().resizable().resizable("destroy");n.instance.parent().resizable(n.options.resizable);n.search.off("keyup.datalist").on("keyup.datalist",function(i){var r=this;clearTimeout(t);t=setTimeout(function(){(n.filter.search!=r.value||i.keyCode==13)&&(n.filter.search=r.value,n.filter.page=0,n.refresh())},500)});n.rows.spinner().spinner("destroy");n.rows.spinner(n.options.spinner);n.rows.off("keyup.datalist").on("keyup.datalist",function(n){n.which==13&&(this.blur(),this.focus())});n.selector.off("click.datalist").on("click.datalist",function(){n.close()})}},n}(),MvcDatalist=function(){function n(n,t){this.readonly=n.attr("data-readonly")=="true";this.multi=n.attr("data-multi")=="true";this.filter=new MvcDatalistFilter(n);this.for=n.attr("data-for");this.url=n.attr("data-url");this.selected=[];this.browse=$('.datalist-browse[data-for="'+this.for+'"]');this.valueContainer=$('.datalist-values[data-for="'+this.for+'"]');this.values=this.valueContainer.find(".datalist-value");this.control=n.find(".datalist-control");this.search=n.find(".datalist-input");this.group=n;this.dialog=new MvcDatalistDialog(this);this.initOptions();this.set(t);this.methods={reload:this.reload};this.reload(!1);this.cleanUp();this.bind()}return n.prototype={set:function(n){n=n||{};this.dialog.set(n);this.events=$.extend(this.events,n.events);this.search.autocomplete($.extend(this.options.autocomplete,n.autocomplete));this.setReadonly(n.readonly==null?this.readonly:n.readonly)},initOptions:function(){var n=this;this.options={autocomplete:{source:function(t,i){$.ajax({url:n.url+n.filter.getQuery({search:t.term,rows:20}),success:function(t){i($.grep(t.Rows,function(t){return n.indexOf(n.selected,t.DatalistIdKey)<0}).map(function(n){return{label:n.DatalistAcKey,value:n.DatalistAcKey,data:n}}))},error:function(){n.stopLoading()}})},search:function(){n.startLoading(300)},response:function(){n.stopLoading()},select:function(t,i){n.select(n.selected.concat(i.item.data),!0);t.preventDefault()},minLength:1,delay:500}}},setReadonly:function(n){this.readonly=n;n?(this.search.autocomplete("disable").attr("readonly","readonly"),this.group.addClass("datalist-readonly")):(this.search.autocomplete("enable").removeAttr("readonly"),this.group.removeClass("datalist-readonly"));this.resizeDatalistSearch()},reload:function(n){var t=this,i;n=n==null?!0:n;i=$.grep(t.values.map(function(n,t){return encodeURIComponent(t.value)}).get(),Boolean);i.length>0?(t.startLoading(300),$.ajax({url:t.url+t.filter.getQuery({ids:"&ids="+i.join("&ids="),rows:i.length}),cache:!1,success:function(r){var f,u,e;for(t.stopLoading(),f=[],u=0;u<i.length;u++)e=t.indexOf(r.Rows,i[u]),e>=0&&f.push(r.Rows[e]);t.select(f,n)},error:function(){t.stopLoading()}})):t.select([],n)},select:function(n,t){if(this.events.select){var i=$.Event("select.datalist");if(this.events.select.apply(this,[i,n,t]),i.isDefaultPrevented())return}this.selected=n;this.multi?(this.search.val(""),this.values.remove(),this.control.find(".datalist-item").remove(),this.createSelectedItems(n).insertBefore(this.search),this.values=this.createValues(n),this.valueContainer.append(this.values),this.resizeDatalistSearch()):n.length>0?(this.values.val(n[0].DatalistIdKey),this.search.val(n[0].DatalistAcKey)):(this.values.val(""),this.search.val(""));t&&(this.search.change(),this.values.change())},createSelectedItems:function(n){for(var i,r,u=[],t=0;t<n.length;t++)i=document.createElement("span"),i.className="datalist-close",i.innerHTML="x",r=document.createElement("div"),r.innerText=n[t].DatalistAcKey,r.className="datalist-item",r.appendChild(i),this.bindDeselect($(i),n[t].DatalistIdKey),u[t]=r;return $(u)},createValues:function(n){for(var t,r=[],i=0;i<n.length;i++)t=document.createElement("input"),t.setAttribute("type","hidden"),t.setAttribute("name",this.for),t.className="datalist-value",t.value=n[i].DatalistIdKey,r[i]=t;return $(r)},startLoading:function(n){this.loading=setTimeout(function(n){n.search.addClass("datalist-loading")},n,this)},stopLoading:function(){clearTimeout(this.loading);this.search.removeClass("datalist-loading")},bindDeselect:function(n,t){var i=this;n.on("click.datalist",function(){i.select(i.selected.filter(function(n){return n.DatalistIdKey!=t}),!0);i.search.focus()})},indexOf:function(n,t){for(var i=0;i<n.length;i++)if(n[i].DatalistIdKey==t)return i;return-1},resizeDatalistSearch:function(){var i=this.control.width(),n=this.control.find(".datalist-item:last"),t;n.length>0?(t=Math.floor(i-n.position().left-n.outerWidth(!0)),t>i/3?this.search.outerWidth(t,!0):this.search.css("width","")):this.search.css("width","")},cleanUp:function(){this.group.removeAttr("data-readonly");this.group.removeAttr("data-filters");this.group.removeAttr("data-dialog");this.group.removeAttr("data-search");this.group.removeAttr("data-multi");this.group.removeAttr("data-order");this.group.removeAttr("data-title");this.group.removeAttr("data-page");this.group.removeAttr("data-rows");this.group.removeAttr("data-sort");this.group.removeAttr("data-url")},bind:function(){var n=this,i,t;$(window).on("resize.datalist",function(){n.resizeDatalistSearch()});n.search.on("keydown.datalist",function(t){t.which==8&&this.value.length==0&&n.selected.length>0&&n.select(n.selected.slice(0,-1),!0)});n.search.on("keyup.datalist",function(t){!n.multi&&t.which!=9&&this.value.length==0&&n.selected.length>0&&n.select([],!0)});n.browse.on("click.datalist",function(){n.readonly||n.dialog.open()});for(i=n.filter.additionalFilters,t=0;t<i.length;t++)$('[name="'+i[t]+'"]').on("change.datalist",function(t){if(n.events.filterChange&&n.events.filterChange.apply(n,[t]),!t.isDefaultPrevented()&&n.selected.length>0){n.startLoading(300);var i=$.grep(n.values.map(function(n,t){return encodeURIComponent(t.value)}).get(),Boolean);$.ajax({url:n.url+n.filter.getQuery({checkIds:"&checkIds="+i.join("&checkIds="),rows:i.length}),cache:!1,success:function(t){var u,r,f;for(n.stopLoading(),u=[],r=0;r<i.length;r++)f=n.indexOf(t.Rows,i[r]),f>=0&&u.push(t.Rows[f]);n.select(u,!0)},error:function(){n.select([],!0);n.stopLoading()}})}})}},n}();$.fn.datalist=function(n){var t=arguments;return this.each(function(){var r=$(this).closest(".datalist"),i;r.length&&($.data(r[0],"mvc-datalist")?(i=$.data(r[0],"mvc-datalist"),typeof n=="string"?i.methods[n].apply(i,[].slice.call(t,1)):n&&i.set(n)):(typeof n=="string"?(i=new MvcDatalist(r),i.methods[n].apply(i,[].slice.apply(t,1))):i=new MvcDatalist(r,n),$.data(r[0],"mvc-datalist",i)))})};$.fn.datalist.lang={Error:"Error while retrieving records",NoData:"No data found",Select:"Select ({0})",Search:"Search..."};