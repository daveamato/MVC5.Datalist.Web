/*!
 * Datalist 4.1.0
 * https://github.com/NonFactors/MVC5.Datalist
 *
 * Copyright © NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(n){n.widget("mvc.datalist",{_create:function(){this.element.hasClass("datalist-input")&&(this._initOptions(),this._initFilters(),this._initAutocomplete(),this._initDatalistOpenSpan(),this._loadSelected(),this._cleanUp())},_initOptions:function(){var t=this.element,i=this.options,r;i.hiddenElement=n("#"+t.attr("data-datalist-for"))[0];i.sortColumn=t.attr("data-datalist-sort-column");i.sortOrder=t.attr("data-datalist-sort-order");i.page=parseInt(t.attr("data-datalist-page"));r=t.attr("data-datalist-filters");i.filters=r?r.split(","):[];i.search=t.attr("data-datalist-search");i.title=t.attr("data-datalist-title");i.rows=t.attr("data-datalist-rows");i.url=t.attr("data-datalist-url");t.addClass("mvc-datalist")},_initFilters:function(){for(var t=0;t<this.options.filters.length;t++)this._initFilter(n("#"+this.options.filters[t]))},_initFilter:function(t){var i=this;i._on(t,{change:function(){var r=n.Event(i._select);i.options.filterChange&&i.options.filterChange(r,i.element[0],i.options.hiddenElement,t[0]);r.isDefaultPrevented()||i._select(null,!1)}})},_initAutocomplete:function(){var t=this;this.element.autocomplete({source:function(i,r){n.ajax({url:t._formAutocompleteUrl(i.term),success:function(t){r(n.map(t.Rows,function(n){return{label:n.DatalistAcKey,value:n.DatalistAcKey,item:n}}))}})},select:function(n,i){t._select(i.item.item,!1);n.preventDefault()},minLength:1,delay:500});this.element.on("keyup.datalist",function(i){i.which!=9&&this.value.length==0&&n(t.options.hiddenElement).val()&&t._select(null,!1)});this.element.prevAll(".ui-helper-hidden-accessible").remove()},_initDatalistOpenSpan:function(){var r=this.element.nextAll(".datalist-open-span:first"),i;r.length!=0&&(i=this,this._on(r,{click:function(){var r;t.find(".datalist-search-input").off("keyup.datalist").on("keyup.datalist",function(){var n=this;clearTimeout(r);r=setTimeout(function(){i.options.search=n.value;i.options.page=0;i._update(t)},500)}).val(i.options.search);t.find(".datalist-items-per-page").spinner({change:function(){this.value=i._limitTo(this.value,1,99);i.options.rows=this.value;i.options.page=0;i._update(t)}}).val(i._limitTo(i.options.rows,1,99));t.find(".datalist-search-input").attr("placeholder",n.fn.datalist.lang.Search);t.find(".datalist-error-span").html(n.fn.datalist.lang.Error);t.dialog("option","title",i.options.title);t.find(".datalist-table-head").empty();t.find(".datalist-table-body").empty();i._update(t);setTimeout(function(){var n=t.dialog("open").parent();n.position({my:"center",at:"center",of:window});parseInt(n.css("left"))<0&&n.css("left",0);parseInt(n.css("top"))<0&&n.css("top",0)},100)}}))},_formAutocompleteUrl:function(n){return this.options.url+"?Search="+n+"&SortOrder=Asc&Rows=20&Page=0"+this._formFiltersQuery()},_formDatalistUrl:function(n){return this.options.url+"?Search="+n+"&SortColumn="+this.options.sortColumn+"&SortOrder="+this.options.sortOrder+"&Rows="+this.options.rows+"&Page="+this.options.page+this._formFiltersQuery()},_formFiltersQuery:function(){for(var i,r="",t=0;t<this.options.filters.length;t++)i=n("#"+this.options.filters[t]),i.length==1&&(r+="&"+this.options.filters[t]+"="+i.val());return r},_defaultSelect:function(t,i){t?(n(this.options.hiddenElement).val(t.DatalistIdKey),n(this.element).val(t.DatalistAcKey)):(n(this.options.hiddenElement).val(null),n(this.element).val(null));i||(n(this.options.hiddenElement).change(),n(this.element).change())},_loadSelected:function(){var t=this,i=n(t.options.hiddenElement).val();i&&n.ajax({url:t.options.url+"?Id="+i+"&Rows=1"+this._formFiltersQuery(),cache:!1,success:function(n){n.Rows.length>0&&t._select(n.Rows[0],!0)}})},_select:function(t,i){var r=n.Event(this._defaultSelect);this.options.select&&this.options.select(r,this.element[0],this.options.hiddenElement,t,i);r.isDefaultPrevented()||this._defaultSelect(t,i)},_limitTo:function(n,t,i){return(n=parseInt(n),isNaN(n))?20:n<t?t:n>i?i:n},_cleanUp:function(){this.element.removeAttr("data-datalist-sort-column");this.element.removeAttr("data-datalist-sort-order");this.element.removeAttr("data-datalist-filters");this.element.removeAttr("data-datalist-search");this.element.removeAttr("data-datalist-title");this.element.removeAttr("data-datalist-rows");this.element.removeAttr("data-datalist-page");this.element.removeAttr("data-datalist-url")},_update:function(t){var i=this,u=t.find(".datalist-search-input").val(),r;t.find(".datalist-error-container").fadeOut(300);r=setTimeout(function(){t.find(".datalist-processing").fadeIn(300);t.find(".datalist-pager").fadeOut(300);t.find(".datalist-data").fadeOut(300)},500);n.ajax({url:i._formDatalistUrl(u),cache:!1,success:function(n){i._updateHeader(t,n.Columns);i._updateData(t,n);i._updateNavbar(t,n.FilteredRows);clearTimeout(r);t.find(".datalist-processing").fadeOut(300);t.find(".datalist-error-container").hide();t.find(".datalist-pager").fadeIn(300);t.find(".datalist-data").fadeIn(300)},error:function(){clearTimeout(r);t.find(".datalist-error-container").fadeIn(300);t.find(".datalist-processing").hide();t.find(".datalist-pager").hide();t.find(".datalist-data").hide()}})},_updateHeader:function(t,i){for(var u,r=this,f="",e=0;e<i.length;e++)(u=i[e],u.Hidden)||(f+='<th class="'+(u.CssClass||"")+'" data-column="'+u.Key+'"><span class="datalist-header-title">'+(u.Header||"")+"<\/span>",r.options.sortColumn==u.Key||r.options.sortColumn==""&&e==0?(f+='<span class="datalist-sort-arrow '+(r.options.sortOrder=="Asc"?"asc":"desc")+'"><\/span><\/th>',r.options.sortColumn=u.Key):f+='<span class="datalist-sort-arrow"><\/span><\/th>');t.find(".datalist-table-head").html("<tr>"+f+'<th class="datalist-select-header"><\/th><\/tr>');t.find(".datalist-table-head th").click(function(){var i=n(this);if(!i.attr("data-column"))return!1;r.options.sortOrder=r.options.sortColumn==i.attr("data-column")?r.options.sortOrder=="Asc"?"Desc":"Asc":"Asc";r.options.sortColumn=i.attr("data-column");r._update(t)})},_updateData:function(t,i){var c,s,u,f,l,e,o,h,r;if(i.Rows.length==0){c=i.Columns?i.Columns.length+1:1;t.find(".datalist-table-body").html('<tr><td colspan="'+c+'" style="text-align: center">'+n.fn.datalist.lang.NoData+"<\/td><\/tr>");return}for(s="",u=0;u<i.Rows.length;u++){for(f="<tr>",l=i.Rows[u],e=0;e<i.Columns.length;e++)(o=i.Columns[e],o.Hidden)||(f+='<td class="'+(o.CssClass||"")+'">'+(l[o.Key]||"")+"<\/td>");f+='<td class="datalist-select-cell"><div class="datalist-select-container"><i><\/i><\/div><\/td><\/tr>';s+=f}for(t.find(".datalist-table-body").html(s),h=t.find(".datalist-table-body tr"),r=0;r<h.length;r++)this._bindSelect(t,h[r],i.Rows[r])},_updateNavbar:function(n,t){var r=n.find(".datalist-items-per-page").val(),i=parseInt(t/r)+1;t%r==0&&i--;i==0?n.find(".datalist-pager > .pagination").empty():this._paginate(i)},_paginate:function(i){var o=Math.floor(this.options.page/5)*5,u=this.options.page,r=o,f="",s=this,e;for(i>5&&u>0&&(f='<li><span data-page="0">&laquo;<\/span><\/li><li><span data-page="'+(u-1)+'">&lsaquo;<\/span><\/li>');r<i&&r<o+5;)e="",r==this.options.page&&(e=' class="active"'),f+="<li"+e+'><span data-page="'+r+'">'+ ++r+"<\/span><\/li>";i>5&&u<i-1&&(f+='<li><span data-page="'+(u+1)+'">&rsaquo;<\/span><\/li><li><span data-page="'+(i-1)+'">&raquo;<\/span><\/li>');t.find(".datalist-pager > .pagination").html(f).find("li:not(.active) > span").click(function(){s.options.page=parseInt(n(this).data("page"));s._update(t)})},_bindSelect:function(n,t,i){var r=this;r._on(t,{click:function(){n.dialog("close");r._select(i,!1)}})},_destroy:function(){var n=this.element,t=this.options;return n.attr("data-datalist-filters",t.filters.join()),n.attr("data-datalist-sort-column",t.sortColumn),n.attr("data-datalist-sort-order",t.sortOrder),n.attr("data-datalist-search",t.search),n.attr("data-datalist-title",t.title),n.attr("data-datalist-rows",t.rows),n.attr("data-datalist-page",t.page),n.attr("data-datalist-url",t.url),n.removeClass("mvc-datalist"),n.autocomplete("destroy"),this._super()}});n.fn.datalist.lang={Error:"Error while retrieving records",NoData:"No data found",Search:"Search..."};var t=n("#Datalist");n(function(){t.find(".datalist-items-per-page").spinner({min:1,max:99});t.dialog({dialogClass:"datalist-dialog",autoOpen:!1,minHeight:210,height:"auto",minWidth:455,width:"auto",modal:!0});n(".datalist-input").datalist()})})(jQuery);